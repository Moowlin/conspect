202104221024
Tags:
___

# Протокол DNS
Протокол DNS использует **[[Модель клиент-сервер | модель клиент-сервер]]**, причем в качестве клиента может выступать, как клиент DNS, так и сервер DNS, которые работают в рекурсивном режиме. В этом случае сервер DNS пересылают запросы другим серверам DNS и выступает в качестве клиента. Взаимодействие ведется в **режиме запрос-ответ**, соединение не устанавливается, используется [[Протокол UDP]], номер порта 53.

## Формат пакета DNS
Пакет DNS состоит из двух частей заголовок и данные. Заголовок свою очередь состоит из шести полей.
![[format-paket-DNS.jpg]]

### Заголовок:
- **Идентификатор** запроса, любое целое число должно быть одинаково в запросе и ответе.
- Поле флаги состоит из нескольких полей:
	- Поле QR — тип операции запрос (0) или ответ (1).	
	- Поле OPCODE (4 бита) — тип запроса, но на практике используются только 0-стандартный запрос.
	- Флаг AA указывает, является полученный ответ авторитетным (1) или нет (0).
	- Флаг TC говорит о том был пакет обрезан (1) или не был (0).
	- Флаг RD указывается только в запросах, если этот флаг установлен, клиент просит сервер работать в рекурсивном режиме.
	- Флаг RA используется только в ответах, с помощью этого флага сервер сообщает, что он может работать в рекурсивном режиме.
	- Флаг Z зарезервирован для будущего использования.
	- RCODE (4 бита) последние четыре бита это статус выполнение операции, статус 0 говорит о том что операция прошла успешно, любые другие коды говорят о том что произошла какая-то ошибка.
- И четыре поля, которые указывают сколько у нас данных в пакете. Количество DNS запросов, количество DNS ответов, количество ответов об авторитетных серверах и количество дополнительных ответов.

### Данные:
-   В поле данных у нас содержится информация о запросах DNS, где мы указываем доменное имя компьютера для которого хотим узнать ip-адрес.
-   Ответов DNS в которых содержится ip-адрес необходимого нам компьютера.
-   Поле авторитетные серверы используется ветеративном режиме работы, здесь указываются ip-адреса серверов, которые отвечают за интересующую нас DNS зону.
-   И в поле дополнительной информации указываются некоторые дополнительные записи, которые могут быть нам полезны.

В одном и том же DNS пакете может быть несколько запросов DNS и несколько ответов, в том числе несколько ответов на один запрос, если одному доменному имени соответствует несколько ip-адресов.

## Формат запроса DNS
Формат DNS запроса очень простой, содержит имя, тип и класс записи.
Например, имя www.yandex.ru, тип записи 1, (запись типа A) отображение доменного имени в ip- адрес. В системе DNS также используются другие типы записей. Класс записи 1 (IN, Интернет) код единица, других классов записей в системе DNS сейчас не используется.
![[primer-zaprosa-dns.jpg]]

## Формат ответа DNS
[[Пример записи DNS]]

Формат DNS ответа более сложный:
- имя
- [[Протокол DNS#Основные ресурсные записи DNS|Типы записей DNS]] 
- класс записи
- время жизни - это время, на которые запись может сохранить в кэше DNS resolver, 
- длина данных 
- данные ответа

![[format-otveta.jpg]]

> Пример, ответа DNS имя www.yandex.ru, запись типа A, класс записи интернет, время жизни 90 секунд, однако администратор DNS resolver  может принудительно установить другое время жизни. Длина данных измеряется в байтах, 4 байта и ip-адрес сервера www.yandex.ru.
> ![[Pasted image 20220214164419.png]]


# Основные ресурсные записи DNS
Ресурсные записи почти всегда одинаковые, но для некоторых записей могут появляться другие поля, например в MX-записях также присутствует значение приоритета. В основном ресурсные записи имеют следующую структуру:

```
Имя записи   TTL   Класс   Тип записи  Значение
```

Разберём подробнее:
==Имя записи== — указывается домен, которому принадлежит данная ресурсная запись.
==TTL== _(time to live / время жизни)_ — время в секундах, на которое будет закешировано значение ресурсной записи. Это необходимо для разгрузки DNS-серверов. Благодаря кешированию и возможна ситуация, что ближайший DNS-сервер знает IP-адрес запрашиваемого домена.
==Класс== — предполагалось, что DNS может работать не только в сети интернет, поэтому в записи указывается и её класс. На сегодняшний день поддерживается только одно значение — IN (Internet).
==Тип==— указывает тип ресурсной записи, основные из которых были разобраны выше.
==Значение== — непосредственно значение ресурсной записи. В зависимости от типа ресурсной записи значения могут быть представлены в разном виде.

> Отправить запрос на DNS-сервер можно с помощью утилиты [[Команда dig | dig]]

## Запись A и АААА
**Запись A** (address) - адресная запись, которая указывает на соответствие между доменным именем и IP-адресом (IPv4)
**AAAA** (IPv6 address record) - адресная запись, которая указывает на соответствие между доменным именем и IP-адресом (IPv6)
![[Pasted image 20210427203805.png]]

## DNS псевдонимы

> CNAME также называется «каноническое имя», которое является перенаправлением в файл зоны для заданного доменного имени.
CNAME-запись дает возможность присваивать домену или поддомену другой адрес или хостнейм.  
Эту запись можно использовать для множества целей. Например:
Если вы беспокоитесь о том, что кто-то прописывает ваш домен неправильно в адресной строке как _ww.вашсайт.сом_ или _wwww.вашсайт.сом_, обычно это приведет к получению ошибки. Для того чтобы это преодолеть, можно задать CNAME-записи для вашего домена для _ww.вашсайт.сом_ или _wwww.вашсайт.сом_, чтобы они указывали на _www.вашсайт.сом_, таким образом чтобы даже при неправильном вводе адреса посетители все равно перенаправлялись на ваш сайт.
Также можно использовать CNAME для направления домена на другое доменное имя, это схоже с веб-перенаправлением, вы можете создать запись CNAME, которая будет указывать на _google.com_. Так чтобы при наборе в адресной строке браузера _www.вашсайт.сом_ вас перенаправляло сразу на _google.com_.
CNAME выгодно использовать когда один сайт находится в статусе разработки. Например, поддомен который является одной из рубрик сайта — _www.спорт.вашсайт.сом_, можно перенаправить на _www.вашсайт.сом_ на время разработки.

Для одного и того же IP-адреса можно задавать несколько доменных имен. Есть два варианта, как это можно сделать:
1. Использовать DNS запись типов CNAME (Canonical Name каноническое имя) эта запись определяет псевдоним для доменного имени. Для наследования одним доменом всех ресурсных записей другого домена, за исключением NS
2. Альтернативный способ - создать большое количество _A_ записей, которые указывают на один и тот же ip адрес
![[Pasted image 20210427203921.png]]

## Адрес почтового сервера
запись специального ==типа MX==(Mail eXechange) позволяет узнать адрес почтового сервера
![[Pasted image 20210422121517.png]]
Запись MX содержит два поля:
1. приоритет
2. адрес сервера принимающего почту для данного домена

## Запись TXT
==TXT (Text string)== — запись, которая содержит любую текстовую информацию о домене. Записи TXT используются для различных целей: подтверждения права собственности на домен, обеспечения безопасности электронной почты, а также подтверждения SSL-сертификата. Часто применяется для проверок на право владения доменом при подключении дополнительных сервисов, а также как контейнер для записи SPF и ключа DKIM. Можно прописывать неограниченное количество TXT-записей, если они не конфликтуют друг с другом.

 ## Записи серверов имен
==Запись типа NS (Name Server)== - указывает на DNS-сервер, обслуживающий данный домен, т.е. указывает серверы, на которые домен делегирован. Критически важна для функционирования самой системы доменных имён
 ==Записи типа ns задаются на домене более высокого уровня== в нашем случае на сервере, который отвечает за зону ru. Именно этот сервер содержит записи ns для домена yandex.ru и для домена urfu.ru.

## Адреса сетевых сервисов
 DNS записи ==типа SRV== (Service record) - определяет местоположение, то есть имя хоста и номер порта серверов для определённых служб
 Структуры этой записи достаточно сложны, вместо доменного имени указывается строка с описанием сервисов в специальном формате
 ==(\_сервис.\_протокол.имя.-˃ приоритет вес порт имя).==
 
 ## Определение имени по IP-адресу
 **PTR** (pointer) — запись, которая "связывает" IP-адрес с доменным именем. Многие почтовые серверы при фильтрации входящей почты от спама проверяют наличие PTR-записи и ее соответствие имени сервера-отправителя.

Для определения имени сервера по его IPv4-адресу существует специальная доменная зона in-addr.arpa. Если для адреса задана PTR-запись, то IP-адрес хоста, например, 92.53.96.111, будет транслирован в обратной нотации и преобразован в 111.96.53.92.in-addr.arpa. Запрос PTR-записи 111.96.53.92.in-addr.arpa вернет имя сервера:
![[ptr.png]]

 ## Запись SOA
**Запись SOA** _(Start of Authority)_ начальная запись зоны, которая указывает местоположение эталонной записи о домене. Она содержит в себе контактную информацию лица, ответственного за данную зону, время кэширования информации на серверах и данные о взаимодействии DNS. SOA-запись создается автоматически. **Удалить ее нельзя**.

Параметры, хранящиеся в SOA-записи:

- ==TTL== – время, в течение которого информация будет кешироваться другими DNS-серверами.   
- ==Hostname== – контактный адрес лица, который отвечает за администрирование файла зоны.    
- ==Serial number== – 32-разрядное число, которое содержит в себе серийный номер файла зоны. Изменяется при каждом обновлении зоны.  
- ==Refres== – время (в секундах) ожидания ответа вторичного DNS перед запросом SOA-записи с первичных серверов. По истечении данного времени вторичный DNS обращается к первичному для получения копии текущей SOA-записи. Первичный DNS-сервер выполняет этот запрос. Вторичный DNS-сервер сравнивает полученный серийный номер зоны с имеющимся. Если они отличаются, то осуществляется запрос к первичному DNS-серверу на трансфер зоны.    
- ==Retry== – если сервер недоступен, то в по истечении времени (в секундах), указанного в данном параметре, сервер повторно попытается синхронизировать информацию с первичных DNS-серверов.    
- ==Expire== – время (в секундах), в течение которого вторичный DNS будет пытаться завершить синхронизацию зоны с первичным. Если это время истечет до того, как синхронизация закончится, то зона на вторичном DNS-сервере перестанет обслуживать запросы об этой зоне.    
- ==Minimum TTL== – время жизни кэша для негативного ответа на запрос в зонe.

![[soa_dns_2.png]]


> **ИТОГ**
> Типы записей DNS: 
> - A – адрес IPv4
> - AAAA – адрес IPv6
> - CNAME – псевдоним для доменного имени
> - MX – адрес почтового сервера
> - SRV – адреса и порты сетевых сервисов
> - NS – адреса DNS-серверов, ответственных за зону
> - PTR – доменное имя для IP-адреса
> - Другие редко используемые типы записей 
>  
> Запрос записей разных типов:
> `nslookup -type=XXX yandex.ru`



# Ссылки
___
##### Links

[[Пример записи DNS]]

---
##### Источники

https://timeweb.com/ru/help/pages/viewpage.action?pageId=11338153
https://www.reg.ru/support/dns/Nastroika-zony/chto-takoe-resursnye-zapisi-dns