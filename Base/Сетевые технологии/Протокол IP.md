202104262136
Tags:
___

# Протокол IP
Протокол IP не содержит достаточных средств для организации надежной доставки сообщения. В частности, пакеты IP теряются в случае если пакет не прошел проверку контрольной суммы, не найден маршрут к заданному узлу назначения (параметр TTL равен нулю) и т.д. Все это сводится к тому, что протокол IP передает сообщения «по возможности» или другими словами, **не прилагает никаких мер для гарантированной доставки сообщений**.

Компенсируют недостаточную надежность протокола IP – протоколы верхних уровней, в частности [[Протокол TCP|протокол TCP]] (транспортный уровень) и [[Протокол DNS|DNS]] (прикладном уровне).

Помимо этого, существует еще один механизм уменьшения ненадежной передачи сообщений протоколом IP – это [[Протокол ICMP|протокол ICMP]].



# Место в моделях OSI и TCP/IP

В модели взаимодействия открытых систем протокол IP, находится на одном и том же уровне — [[Сетевой уровень|сетевом]].

Сетевой уровень стека протоколов TCP/IP включая также и другие протоколы кроме IP. Это ARP, DHCP и ICMP, но для передачи данных используется только протокол IP, остальные протоколы служат для обеспечения корректной работы крупной составной сети.

![[stek-tcp.jpg]]


## Сервисы IP
==Протокол Ip так же как и Ethernet использует передачу данных без установки соединения.== Считается, что ошибка должна быть исправлена протоколами, которые находятся на вышестоящих уровнях.

## Задачи IP
* объединение сети, построенных на основе разных технологий канального уровня в одну крупную объединенную сеть, в которой компьютеры могут свободно общаться друг с другом
* маршрутизация, то есть поиск маршрута от отправителя к получателю в крупной составной сети через промежуточные узлы маршрутизаторы

## Формат заголовка IP-пакета
![[Pasted image 20220111121806.png]]

1. **Номер версии** - Сейчас используется две версии протокола [[IPv4- адреса| IPv4]] и [[IPv6-адреса | IPv6]]
2. **Длина заголовка** - заголовок IP включает обязательные поля, а также может включать дополнительные поля, которые называются опции. В поле длина заголовка записывается полная длина, как обязательной части, так и опции.
3. **Тип сервиса** - Это поле нужно для обеспечения необходимого качества обслуживания, но сейчас на практике используется очень редко.
4. Общая длина - Общая длина содержит длину всего IP пакета, включая заголовок и данные. Максимальная длина пакета 65 535 байт, но на практике такие большие пакеты не используются, а максимальный размер ограничен размером кадра канального уровня, а для Ethernet это 1 500 байт. В противном случае для передачи одного IP пакета необходимо было бы несколько кадров канального уровня что неудобно.
5. **Идентификатор пакета**, **флаги** и **смещение фрагмента** используются для реализации фрагментации.
	1. *Пакет* задает номер пакета, который разбит на фрагменты. Это поле должн быть одинаковое во всех фрагментах пакета
	2. *Флаги* - размер поля 3 бита. но на практике используется только два: 
		- *флаг DF (Don't Fragment)* означает запрет фрагментирования -  Если этот флаг установлен, то маршрутизатор не имеет право фрагментировать пакет. В этом случае маршрутизатор просто отбросит пакет и отправит получателю [[Протокол ICMP|ICMP]] сообщений с типом 3, кодом 4, это означает что заданный узел недоступен, необходима фрагментация, но установлен флаг DF запрещающий эту фрагментацию.
		> в следующей версии [[Протокол IPv6| протокола ipv6]] отказались от фрагментации на маршрутизаторах
		- *флаг MF (More Fragments)* означает, что пакет не последний, будут еще пакеты
	3. *Смещение фрагменты* используется для определения последовательности фрагментов для сбора пакетов. Смещенеи измеряется в *8-ми байтовых блоках*
		> **Пример**
		> -   У нас есть большой пакет размером 4 тысячи байт, в этом пакете 20 байт, это заголовок IP, а полезных данных 3980 байт.
		> -   Мы хотим передать полученные пакет по сети Ethernet, у который максимальный размер передаваемых данных 1 500 байт. Опять же с 1500 байт, 20 байт отдается под заголовок IP, и 1480 байт под полезные данные.
		> -   Таким образом, исходные данные размером 3 980 байт, будут разделены на три фрагмента, от 0 до  4179 байт, от 1480 до 2959, от  2960 до 3890.
		> -   Для того чтобы получить смещение каждого фрагмента, мы должны взять значение первого байта (это 0, 1480 и 2960), и разделить на 8, таким образом смещение получается 0 для первого фрагмента, 185 для второго фрагмента, и 370 для третьего фрагмента.
6. **Время жизни** — это максимальное время в течение которого пакет может перемещаться по сети. Оно введено для того чтобы пакеты не гуляли по сети бесконечно, если в конфигурации сети возникла какая-то ошибка. Например, в результате неправильной настройке маршрутизаторов в сети, может образоваться петля. Раньше, время жизни измерялось в секундах, но сейчас маршрутизаторы обрабатывают пакет значительно быстрее чем за секунду, поэтому время жизни уменьшается на единицу на каждом маршрутизаторе, и оно измеряется в количествах прохождения через маршрутизаторы по-английски (hop) от слова прыжок. Таким образом название время жизни сейчас стало уже некорректным.
7. **Тип протокола** следующего уровня. Это поле необходимо для реализации функции мультиплексирования и демультиплексирования, то есть передачи с помощью протокола IP данных от разных протоколов следующего уровня. В этом поле указывается код протокола следующего уровня, некоторые примеры кодов для [[Протокол TCP| TCP]] код 6, [[Протокол UDP| UDP]]— 17 и [[Протокол ICMP| ICMP]] — 1.
8. **Контрольная сумма**, которая используется для проверки правильности доставки пакета, если при проверке контрольные суммы обнаруженные ошибки, то пакет отбрасывается, никакой информации отправителю пакета не отправляется. Контрольная сумма рассчитывается только по заголовку IP пакета и она пересчитывается на каждом маршрутизаторе из-за того что данные в заголовке меняются. Как минимум изменяется время жизни пакета, а также могут измениться некоторые опции.
9. **IP адреса получателя и отправителя** на этом обязательная часть IP заголовка заканчивается
10. **Опции** может быть несколько и они могут иметь разный размер. В то же время длина IP заголовка должна быть кратна 32, поэтому при необходимости, в конце IP заголовок заполняются нулями до выравнивание по границе 32 бита. Следует отметить, что сейчас опции в заголовке IP почти не используются.
	Для диагностики работы сети используется опция — записать маршрут, при которой в IP пакет записывается адрес каждого маршрутизатора через которую он проходит.
	И опция — временные метки, при установке которой, каждый маршрутизатор записывает время прохождения пакеты.

	Также опции позволяют отказаться от автоматической маршрутизации, и задать маршрут отправитель:

	-   Это может быть жесткая маршрутизация, где в пакете явно указывается перечень маршрутизаторов через которые необходимо пройти.
	-   И свободные маршрутизации в этом случае указываются только некоторые маршрутизаторы, через которые пакет должен пройти обязательно, также при необходимости он может пройти через другие маршрутизаторы.



# Ссылки
___
##### Links
[[Протокол IP маршрутизация]]
[[Протокол IP фрагментация]]
[[IP-адреса]]

---
##### Источники
