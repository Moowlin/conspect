202201071845
Tags:
___
# Протокол STP

При кольцевом подключении коммутаторов в Ethernet может возникнуть *широковещательный шторм*
Во избежание его используется протокл STP

Протокол связующего дерева (Spanning Tree Protocol) или иногда называют протокол остовного дерева. Протокол STP позволяет отключать на программном уровне некоторые соединения между коммутаторами, чтобы не образовывалось кольцо.

Связующее дерево или остовное дерево, как его чаще называют в математике это подграф без циклов, содержащий все вершины исходного графа. Связующее дерево содержит все наши исходные коммутаторы, но при этом в нем циклов, т.е. Ethernet в такой конфигурации точно будет работать.

Протокол STP определен в стандарте IEEE 802.1D. Благодаря этому протоколу можно создавать несколько соединений между коммутаторами. Это повышает надежность работы сети. Если по какой-то причине одно соединение разорвется, то можно будет использовать другое соединение.

Еще одно преимущество протокола STP в том, что он защищает от случайных ошибок в конфигурации ethernet. Конечно же никто не хочет, чтобы вся его сеть ethernet остановилась, если по ошибке включили кабель не в тот коммутатор и случайно создали кольцо. Протокол STP защищает от такой ситуации.


## Место протокола STP в модели OSI

В модели взаимодействия открытых систем протокол STP находится на [[Канальный уровень|канальном уровне]], он реализуется на коммутаторах.


## Этапы работы протокола STP

Работа протокола STP состоит из трех этапов. На первом этапе выбирается корневой коммутатор. На втором этапе рассчитываются кратчайшие пути от всех коммутаторов в сети до корневого коммутатора. На 3 этапе отключаются все остальные соединения, кроме кратчайших.


### Сообщения протокола STP

Чтобы реализовать протокол STP, коммутаторы обмениваются между собой сообщениями, которые называются *Bridge Protocol Data Units (BPDU)*. Протокол STP был разработан в 80-е годы, поэтому вместо термина коммутатор switch используется термин bridge мост, который был более популярен в то время.

Такие сообщения отправляют все коммутаторы в сети, которые поддерживают протокол STP каждые 2 секунды.

В качестве адреса получателя используется групповой [[MAC адреса|MАК-адрес]] STP. Все Ethernet коммутаторы, которые поддерживают STP принимают и обрабатывают кадры, которые приходят на этот групповой адрес (**01:80:С2:00:00:00)**.

### Выбор корневого коммутатора

На первом этапе выполняется выбор корневого коммутатора. Выбор выполняется по идентификатору, в качестве корневого выбирается коммутатор, у которого этот идентификатор минимальный.

Сейчас в качестве идентификатора коммутаторов используется его МАК-адрес, но можно повлиять на значение идентификатора вручную, чтобы выбрать в качестве корневого наиболее мощный коммутатор в вашей сети, а не тот коммутатор, у которого случайно оказался самый маленький МАК-адрес.

### Расчет кратчайших путей

Теперь необходимо рассчитать кратчайшие пути от всех коммутаторов до корневого коммутатора. Длина пути между коммутаторами определяется в зависимости от двух параметров:

-   количество промежуточных коммутаторов;
-   скорость соединений между промежуточными коммутаторами.

Расчет путей до корневого коммутатора реализуется по схеме похожей на выбор корневого коммутатора. Все коммутаторы рассылают на все порты управляющее сообщение протокола STP с расстоянием от них до корневого коммутатора.

Расстояние между коммутаторами определено в стандарте IEEE 802.1D. Предположим, что у нас соединение с коммутаторами 1 Гбит/с в этом случае в качестве значения расстояния мы используем число 4,как в таблице ниже.

![[Pasted image 20220108120428.png]]


На первом этапе, коммутаторы, которые подключены непосредственно к корневому коммутатору, определяют скорость соединения с этим коммутатором и выбирают соответствующее значение расстояния.

Следующая задача отключить одно из соединений, чтобы не было кольца. Согласно правилам протокола STP, если у нас есть два пути до корневого коммутатора, мы должны выбрать тот путь, у которого расстояние минимально, а другой путь отключить. Но в нашем примере два пути с одинаковым расстоянием 8. В этом случае отключается тот путь, у которого больше значение порта.

Если порты нумеруются слева направо, то будет отключен порт справа.


## Состояние портов в STP

Если мы используем протокол STP, то при подключении устройства к коммутатору нельзя сразу же начать передавать данные, ведь там может оказаться другой коммутатор и новое соединение может привести к созданию кольца. Для того чтобы избежать этой проблемы, коммутаторы которые поддерживают протокол STP используют несколько режимов работы портов.

- На первом этапе, когда кабель только что подключен к порту коммутатора, порт работает в режиме *Listening* — порт обрабатывает управляющее сообщение протокола STP, но не передаёт никакие данные.
- На втором этапе, который называется *Learning* — порт принимает данные, но никуда их не передает. Из принятых кадров извлекаются адреса отправителей, которые используются для создания таблицы коммутации.
- На следующем этапе возможно два варианта. Если выяснилось, что к порту подключен компьютер или коммутатор без образования кольца, то порт переходит в состояние *Forwarding* — порт принимает и передает данные, а также принимает и передает управляющее сообщение протоколу STP.
- Но если оказалось, что к порту подключен коммутатор и образовалось кольцо, то порт переходит в состояние *Blocking* — порт блокируется на программном уровне для того, чтобы не было кольца.
- Кроме этого у администратора есть возможность принудительно выключить порт, переведя его в состояние *Disabled*. В этом случае данные не будут передаваться независимо от того, что подключено к порту компьютер, коммутатор, есть кольцо или нет.



## Развитие STP

В протоколе STP переход от состояния, когда Вы только что включили кабель к состоянию Forwarding занимает достаточно долгое время, примерно 30 секунд. В 80-е годы, когда разрабатывали протокол это было допустимо. Но сейчас сети стали гораздо больше и изменяются чаще, поэтому ждать 30 секунд пока сработает STP уже нельзя.

Поэтому был предложен новый вариант протокола STP, который называется *RSTP (Rapid Spanning Tree Protocol)* – быстрый протокол связующего дерева. Он работает по похожим принципам, но срабатывает всего лишь за несколько секунд. Протокол RSTP определен стандартом IEEE 802.1w.

Кроме этого возможны проблемы при взаимодействии протокола STP с [[VLAN|технологией VLAN]]. Вы можете попытаться создать несколько соединений между коммутаторами, которые будут принадлежать разным Vlan. *Но STP в исходном варианте ничего не знает про vlan поэтому соединение между коммутаторами в разных vlan будут отключены.*

> Для того, чтобы можно было использовать технологию vlan совместно с протоколом STP необходимо, чтобы связующее дерево строилось для каждого vlan отдельно. Эту возможность реализовали в *протоколе Multiple Spanning Tree Protocol (MSTP)*, который определен в стандарте 802.1s.

# Ссылки
___
##### Links


---
##### Источники















